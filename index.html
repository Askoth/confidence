<html>
    <head>
        <title>So You Think You Can Test?</title>
        <link rel="stylesheet" type="text/css" href="confidence.css">
        <script type="text/javascript" src="jquery/jquery-1.9.1.min.js"></script>
        <script type="text/javascript" src="jquery/jquery-ui.min.js"></script>
        <script type="text/javascript" src="vue/vue.js"></script>
        <script type="text/javascript" src="jstat/jstat.min.js"></script>
        <script type="text/javascript" src="experiment.js"></script>
    </head>
    <body>
		<div id="app-confidence">
			<div class="message_box" v-if="game_state != 'play'">

				<!-- A general introduction to the game. -->
				<div class="content intro" v-if="game_mode == ''">
					<h1>So You Think You Can Test?</h1>
					<p>Decision making under uncertainty is complicated business. This game aims to make decision makers more aware of the complex trade off between indecision and acting on insufficient information.</p>
					<p class="button arcade_mode" v-on:click="game_mode = 'arcade'">Arcade-mode <small>(fast-paced time-based action)</small></p>
					<p class="button sim_mode" v-on:click="game_mode = 'sim'">Simulation-mode <small>(realistic turn-based simulation)</small></p>
					<small>Created by <a href="http://www.lukasvermeer.nl">Lukas Vermeer</a> &mdash; Make this more awesome on <a href="https://github.com/lukasvermeer/confidence">GitHub</a></small>
				</div>

				<!-- Game rules for Arcade-mode. -->
				<div class="content arcade_intro" v-if="game_mode == 'arcade' && game_state == ''">
					<h1>Arcade-mode</h1>
					<p>You will be presented with a series of ten independently simulated experiments. Only one of these is simulating a scenario where there is a difference in effect between base and variant. The other nine are so-called A/A experiments, with absolutely no difference between the two treatment groups.</p>
					<p>Because of random fluctuations, combined with the fact that we observe the experiments as they are simulated, all ten result will seem to change over time. <b>Your job as a decision maker is to identify which of these ten experiments is <i>not</i> an A/A.</b></p>
					<p>Once you are certain you've identified the right experiment, make your choice known by clicking (or by using the numeric keys "0" through "9"). With every subsequent level, the size of the simulated effect will diminish, making your task progressively more difficult. A point is awarded for correct decisions; mistakes will cost a point. When visitors reaches zero, the game is over.</p>
					<p>This is a game of chance, but not of chance alone. Good luck!</p>
					<p class="button arcade_start" v-on:click="start_arcade_game">Start</p>
				</div>

				<!-- Game rules for Simulation-mode. -->
				<div class="content sim_intro" v-if="game_mode == 'sim' && game_state == ''">
					<h1>Simulation-mode</h1>
					<p>This game is nowhere near finished. Please only play to get an idea of current status.</p>
					<p>This description is also work in progress. :-)</p>
					<p>This is a game of chance, but not of chance alone. Good luck!</p>
					<p class="button sim_start" v-on:click="start_sim_game">No Start</p>
				</div>

				<!-- End game feedback. -->
				<div class="content over" v-if="game_mode == 'arcade' && game_state == 'eval'">
					<h1>
						<span v-if="level == 1">Paradox Of Choice, hmm?</span>
						<span v-if="score < 0">Worse Than Random</span>
						<span v-if="level > 1 && score == 0">You Win Some, You Lose Some</span>
						<span v-if="score > 0 && score <= 2">Okay, I Guess</span>
						<span v-if="score > 2 && score <= 4">Great Job, No Really</span>
						<span v-if="score == 5 && level < 7">That's Awesome! Can You Do Better?</span>
						<span v-if="score == 5 && level >= 7">Easy Does It</span>
						<span v-if="score == 6">Best Probable Score. Seriously.</span>
						<span v-if="score > 6">You Can See The Matrix!</span>
					</h1>
					<p>The game is over. Time to evaluate how well you've performed.</p>
					<p><b id="perf_summary">You made {{level-1}} decisions and scored a total of {{score}} points. <span v-if="score>4">That's awesome!</span></b></p>
					<p id="perf_long">
						<span v-if="level == 1">Just remember that not making any decisions is also a choice. you might not have made any mistakes, but you've also not really added any value to the company. Perhaps you were sleeping?</span>
						<span v-if="score < 0">Sure, you were decisive, but sometimes it is better to wait before you make a decision.</span>
						<span v-if="level > 1 && score == 0">Maybe play again and stick to making good decisions only, hmkay?</span>
						<span v-if="score > 0 && score <= 2">Keep in mind that this game is all about a trade off. You cannot win, but you can probably do better.</span>
						<span v-if="score > 2 && score <= 4">This is not an easy game. You should be proud you managed to get a positive score.</span>
						<span v-if="score == 5 && level < 7">This is a very good score! Looks like you made all the right choices, but perhaps you can do even better than this if you make all the right choices just a little bit faster?</span>
						<span v-if="score == 5 && level >= 7">This is a very good score! Looks like you made a few costly mistakes along the way. Perhaps you can do better if you wait just a little bit longer when you\'re not quite confident you're making the right decision?</span>
						<span v-if="score == 6">We've done the math, and the odds of getting a score even higher than this are absolutely astronomically small. This is as close as you'll ever be to beating this game, but perhaps you'd like to try just one more time?</span>
						<span v-if="score > 6">What you've achieved is statistically very improbable. You probably cheated, but you might also simply be The One. If you manage to do this a second time, we'd be very impressed.</span>
					</p>
					<p class="button reset" v-on:click="game_mode = '';  game_state = '';">Click To Play Again</p>
					<small>Created by <a href="http://www.lukasvermeer.nl">Lukas Vermeer</a> &mdash; Make this more awesome on <a href="https://github.com/lukasvermeer/confidence">GitHub</a></small>
				</div>
			</div>

			<!-- Scores header for Arcade-mode. -->
			<div class="header arcade" v-if="game_mode == 'arcade' && game_state == 'play'">
				<span class="bignumber">Effect <span>{{(1/Math.pow(2,level-1)*100).toFixed(2) + '%'}}</span></span>
				<span class="bignumber">Score <span>{{score}}</span></span>
				<span class="bignumber">Visitors <span>{{time.toLocaleString()}}</span></span>
			</div>

			<!-- Scores header for Simulation-mode. -->
			<div class="header sim" v-if="game_mode == 'sim' && game_state == 'play'">
				<span class="bignumber">Day <span>{{day + '/' + TOTAL_DAYS}}</span></span>
				<span class="bignumber">Conversion <span>{{(conversion*100).toFixed(2) + '%'}}</span></span>
				<span class="bignumber">Score <span>{{conversions.toFixed().replace(/\d(?=(\d{3})+$)/g, '$&.')}}</span></span>
			</div>

			<!-- Experiments display for Arcade-mode. -->
			<div v-if="game_state == 'play' && game_mode == 'arcade'" class="experiments">
				<a v-on:click="choose_exp(i)" v-for="(exp,i) in summary_statistics">
					<div class="exp_box" :id="'exp'+exp.experiment_id">
						<div class="exp_box_hoverlay"></div>
						<span class="exp_name">Experiment {{exp.experiment_id}}</span>
						<experiment-table :e="exp"></experiment-table>
					</div>
				</a>
			</div>

			<!-- Experiments display for Simulation-mode. -->
			<div v-if="game_state == 'play' && game_mode == 'sim'" class="experiments">
				<span v-for="(exp,i) in summary_statistics">
					<div class="exp_box" :id="'exp'+exp.experiment_id">
						<div class="exp_box_hoverlay">
							<p class="sim fo exp_button" v-if="exp.active" v-on:click="sim_choose_exp(i, true)">FULL ON</p>
							<p class="sim stop exp_button" v-if="exp.active" v-on:click="sim_choose_exp(i, false)">STOP</p>
						</div>
						<div class="exp_box_overlay sim" v-if="!exp.active">
							<p class="sim feedback">
								The real effect of this experiment was {{((exp.effect[1]-1)*100).toFixed(2)}}%.
							</p>
						</div>
						<div class="exp_box_overlay sim" v-if="exp.active && exp.days == 0">
							<p class="sim feedback">
								New experiment started.<br />
								No data yet.
							</p>
						</div>
						<span class="exp_name">Experiment {{exp.experiment_id}}</span>
						<div class="sim runtime">runtime: {{ exp.days }} days.</div>
						<experiment-table :e="exp"></experiment-table>
					</div>
				</span>
				
				<p class="button next sim" v-if="game_mode == 'sim' && game_state == 'play'" v-on:click="next_round_sim()">Wait Another Day</p>
			</div>

			<!-- Full screen overlays. -->
			<div class="waiting" v-if="game_mode == 'sim' && game_state == 'waiting'"><span>please wait</span></div>
			<div class="wham hurting"><span>firing<br />offense</span></div>
			<div class="wham instant_kill"><span>instant kill</span></div>
			<div class="wham fatality"><span>fatality</span></div>
			<div class="wham false_positive"><span>false positive</span></div>
			<div class="wham just_under_conclusivity"><span>just<br />under<br />conclusivity</span></div>
        </div>

        <script type="text/javascript">
			//
			// Decision making under uncertainty is complicated business. This game aims to make 
			// decision makers more aware of the complex trade off between indecision and acting 
			// on insufficient information.
			//
			var e = [];
			
			confidence = new Vue({
				el: '#app-confidence',
				data: {
					EXPERIMENTS: 10,
					VARIANTS: 2,
					VISITORS_PER_DAY_ARCADE: 500,
					VISITORS_PER_DAY_SIM: 100000,
					TOTAL_VISITORS: 500000,
					TOTAL_DAYS: 28,
					CONVERSION_RATE: 0.05,
					AVERAGE_EFFECT: -0.5,
					AVERAGE_EFFECT_STDDEV: 0.5,
					DEV_CAPACITY: 2,
					
					summary_statistics: [],
					score: 0, 
					level: 0, 
					time: 0,
					day: 0,
					conversion: 0,
					conversions: 0,
					winner: 0,
					game_mode: '',
					game_state: '',
				},
				methods: {
					update_summary_statistics: function() {
						this.summary_statistics = e;

						// This is super nasty. I wish there was a nicer way to ensure Vue updates.
						for (var i = 0; i < this.summary_statistics.length; ++i) {
							this.summary_statistics[i].visits.splice(0,1,this.summary_statistics[i].visits[0]);
						}
					},
					start_arcade_game: function() {
						this.game_mode = 'arcade';
						this.game_state = 'play';
											    
					    // Initialise experiment data.
						e = new Array();
						for (var i = 0; i < this.EXPERIMENTS; ++i) { e.push(new Experiment(i)); }
						this.score = 0; this.level = 0; this.time = this.TOTAL_VISITORS; this.conversion = this.CONVERSION_RATE;
	
						this.next_round_arcade();
						this.recursive_experiment_loop();
					},
					next_round_arcade: function() {
						this.level++;
		
						// Pick a winner.
						this.winner = Math.round(Math.random()*(this.EXPERIMENTS-1));
						effect = (Math.random() < 0.5 ? (1+1/Math.pow(2,this.level-1)) : (1-1/Math.pow(2,this.level-1)));
	
						// Reset experiments.
						for (var i = 0; i < this.EXPERIMENTS; ++i) { e[i].reset(this.winner == i ? effect : 1); }
					},
					next_round_sim: function() {
						if (this.day < this.TOTAL_DAYS) {
							this.game_state = 'waiting';
							setTimeout(function() { confidence.next_round_sim_deferred(); }, 10);
						}
					},
					next_round_sim_deferred: function() {
 						this.run_experiments(this.VISITORS_PER_DAY_SIM);
 						this.day++;

						var dc = this.DEV_CAPACITY;
	
						for (var i = 0; i < e.length; ++i) { 
							if (e[i].active) {
								e[i].days++;
							}
							else {
								if (dc > 0) {
									e[i].reset(1 + jStat.normal.sample(this.AVERAGE_EFFECT, this.AVERAGE_EFFECT_STDDEV) / 100);
									dc--;
								}
							}
						}
						this.game_state = 'play';
					},
					sim_visitor: function() {
						var c = this.conversion;
	
						// assign to treatment for each exp and calculate aggregate effect size.
						var a = [];
						for (var i = 0; i < e.length; ++i) {
							a[i] = e[i].assign_variant();
							c = c * e[i].effect[a[i]];
						}
	
						// converted or not.
						b = false; if (Math.random() <= c) { b = true; this.conversions++; }

						// update exps to reflect.
						for (var i = 0; i < e.length; ++i) {
							if (e[i].active) {
								e[i].visits[a[i]]++;
								if (b) e[i].conversions[a[i]]++;
							}
						}
					},
					run_experiments: function(v) {
						for (var i = 0; i < v; ++i) { this.sim_visitor(); }
						this.update_summary_statistics();
					},
					recursive_experiment_loop: function() {
						this.run_experiments(this.VISITORS_PER_DAY_ARCADE);
						this.time -= this.VISITORS_PER_DAY_ARCADE;
						
						if (this.time > 0) {
							// This feels kinda nasty. Would be nice to use relative instead of global reference.
							this.timeoutID = window.setTimeout(function(){ confidence.recursive_experiment_loop(); }, 10);
						}
						if (this.time <= 0) {
							this.game_state = 'eval';
						}
					},
					start_sim_game: function() {
						this.game_mode = 'sim';
						this.game_state = 'play';
						
						// Initialise experiment data.
						e = new Array();
						for (var i = 0; i < this.EXPERIMENTS; ++i) { e.push(new Experiment(i)); }
						for (var i = 0; i < this.EXPERIMENTS; ++i) { e[i].reset(1 + jStat.normal.sample(this.AVERAGE_EFFECT, this.AVERAGE_EFFECT_STDDEV) / 100); }

						this.conversions = 0; this.day = 0; this.conversion = this.CONVERSION_RATE;

						this.next_round_sim();
					},
					choose_exp: function(e) {
						if (this.time > 0) {
							if(this.winner==e) { 
								$('#exp'+this.winner+' .exp_box_hoverlay').switchClass('', 'correct', 100).switchClass( 'correct', '', 250 );;
								this.score++; 
							} 
							else {
								$('#exp'+this.winner+' .exp_box_hoverlay').switchClass('', 'incorrect', 100).switchClass( 'incorrect', '', 250 );;
								this.score--;
							}
	
							this.next_round_arcade();
						}
					},
					sim_choose_exp: function(exp, fullon) {
						// apply change to conversion
						if (fullon) { this.conversion = e[exp].effect[1] * this.conversion; }

						// reset experiment
						e[exp].end_experiment();
						if (!fullon && e[exp].days == 1) {
							$('.instant_kill').show('scale', { percent: 100 }, 300).fadeOut();
						}
						else if (!fullon && e[exp].days > 1) {
							$('.fatality').show('scale', { percent: 100 }, 300).fadeOut();
						}
						if (fullon && e[exp].get_mean(1)[0] < e[exp].get_mean(0)[0] && e[exp].is_significant()) {
							$('.hurting').show('scale', { percent: 100 }, 300).fadeOut();
						}
						else if (fullon && e[exp].get_mean(1)[0] > e[exp].get_mean(0)[0] && !e[exp].is_significant()) {
							$('.just_under_conclusivity').show('scale', { percent: 100 }, 300).fadeOut();
						}
						else if (fullon && e[exp].get_mean(1)[0] > e[exp].get_mean(0)[0] && e[exp].is_significant() && e[exp].effect[1] <= 1) {
							$('.false_positive').show('scale', { percent: 100 }, 300).fadeOut();
						}
					}
				}
			});

			$(document).ready(function() {
				document.addEventListener('keydown', function(event) {
					if(event.keyCode >= 48 && event.keyCode <= 57) {
						confidence.choose_exp(event.keyCode-48);
					}
					if(event.keyCode == 32) {
						confidence.next_round_sim();
					}
				});
				
				$(".wham").hide()
			});
		</script>
    </body>
</html>